<div class="d-flex">
  <h2 class="pt-2 pb-4 text-primary">Ajouter une course</h2>
  <a class="btn btn-link link-dark text-decoration-none ms-auto" title="Fermer" routerLink="../">
    <i class="ri-close-line ri-2x" aria-hidden="true"></i>
    <span class="visually-hidden">Fermer</span>
  </a>
</div>
<form
  [formGroup]="scheduleFareForm"
  [appLoadAction]="scheduleFare$"
  #loadAction="loadAction"
  (actionSuccess)="onScheduleFareActionSuccess($event)"
  (actionError)="onScheduleFareActionError($event)"
  (ngSubmit)="onSubmitFareToSchedule(loadAction.start)">
  <div class="mb-3">
    <label for="passenger" class="form-label">Identité du passager</label>
    <app-passenger-field
      (selectPassenger)="onSelectPassengerChange($event)"
      (searchPassengerTerm)="onSearchPassengerTermChange($event)"></app-passenger-field>
    <input id="passenger" type="hidden" name="passenger" formControlName="passenger" />

    <div class="row align-items-center mt-3">
      <div class="col-auto">
        <div>ou</div>
      </div>
      <div class="col-auto">
        <a class="btn btn-secondary" ariaCurrentWhenActive="page" routerLinkActive="active" [routerLink]="'register-regular'">
          Enregistrer un passager régulier
        </a>
      </div>
    </div>
  </div>
  <div class="mb-3">
    <label for="phoneToCall" class="form-label">Téléphone à appeler</label>
    <input
      id="phoneToCall"
      type="text"
      placeholder="(+33)/(0) 6 XX XX XX XX"
      class="form-control"
      name="phoneToCall"
      formControlName="phoneToCall" />
  </div>
  <div class="mb-3">
    <label for="departureDatetime" class="form-label">Date et heure du départ</label>
    <input
      id="departureDatetime"
      type="datetime-local"
      class="form-control"
      name="departureDatetime"
      formControlName="departureDatetime" />
  </div>

  <div class="mb-3">
    <label for="departurePlace" class="form-label">Lieu de départ</label>
    <app-place-field (selectPlace)="onSelectDepartureChange($event)"></app-place-field>
    <input id="departurePlace" type="hidden" name="departurePlace" formControlName="departurePlace" />
  </div>
  <div class="mb-3">
    <label for="arrivalPlace" class="form-label">Lieu d'arrivée</label>
    <app-place-field (selectPlace)="onSelectArrivalChange($event)"></app-place-field>
    <input id="arrivalPlace" type="hidden" name="arrivalPlace" formControlName="arrivalPlace" />
  </div>
  <app-estimate-journey-fields
    [form]="$any(scheduleFareForm)"
    [estimateJourney]="estimateJourney$ | async"
    (formControlUpdated)="updateEstimateFields($event)"></app-estimate-journey-fields>
  <div class="mb-3">
    <label for="driver" class="form-label">Chauffeur</label>
    <!-- TODO Find a better way to link observable to view -->
    <app-driver-field
      [defaultValue]="(selectedSlotContext$ | async)?.rowContext?.driver?.identifier ?? ''"
      (selectDriver)="onSelectDriverChange($event)"></app-driver-field>
    <input id="driver" type="hidden" name="driver" formControlName="driver" />
  </div>
  <div class="mb-3">
    <div class="form-check form-switch">
      <input
        class="form-check-input"
        type="checkbox"
        role="switch"
        id="isTwoWayDrive"
        name="isTwoWayDrive"
        formControlName="isTwoWayDrive"
        checked />
      <label class="form-check-label" for="isTwoWayDrive">Ce trajet comporte un retour</label>
    </div>
  </div>
  <div class="mb-3">
    <div class="form-check form-switch">
      <input
        class="form-check-input"
        type="checkbox"
        role="switch"
        id="isMedicalDrive"
        name="isMedicalDrive"
        formControlName="isMedicalDrive"
        checked />
      <label class="form-check-label" for="isMedicalDrive">Ce trajet est de nature médicale</label>
    </div>
  </div>
  <button
    [appLoadActionDisplay]="loadAction.isLoading$ | async"
    #loadActionDisplay
    type="submit"
    class="btn mt-3 btn-primary w-100"
    [disabled]="loadActionDisplay.isLoading">
    <ng-container slot="loadActionDisplayIdle">Créer la course</ng-container>
    <ng-container slot="loadActionDisplayLoading">
      <span class="spinner-grow spinner-grow-sm me-2" role="status" aria-hidden="true"></span>
      Création en cours...
    </ng-container>
  </button>
  <!-- TODO Mutualiser les erreurs communes -->
  <div class="text-danger mt-2" *ngIf="scheduleFareForm.errors?.['validationFailedBeforeApiCallError']">
    La structure des données de la requête ne respecte pas le contrat de transfer. La requête ne peut pas être effectuée.
    Prévenir Romain qu'il va faire des heures supp'.
  </div>
  <div class="text-danger mt-2" *ngIf="scheduleFareForm.errors">
    Une erreur est survenue lors de l'appel au service distant.
  </div>
</form>
